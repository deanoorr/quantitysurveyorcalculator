<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quantity Surveyor Calculator</title>
  <style>
    /* Basic styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    h1 {
      margin: 0;
      color: #4f46e5;
    }
    
    .project-controls {
      display: flex;
      gap: 10px;
    }
    
    .input-section, .results-section, .saved-items-section {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .input-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .input-tab {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .input-tab.active {
      border-bottom: 2px solid #4f46e5;
      font-weight: 500;
      color: #4f46e5;
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .results-table td {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .results-table td:first-child {
      font-weight: 500;
    }
    
    .results-table td:last-child {
      text-align: right;
      font-family: monospace;
      font-size: 14px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    .btn-primary {
      background-color: #4f46e5;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #4338ca;
    }
    
    .btn-default {
      background-color: #e5e7eb;
      color: #374151;
    }
    
    .btn-default:hover {
      background-color: #d1d5db;
    }
    
    .btn-success {
      background-color: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #059669;
    }
    
    .saved-item {
      background-color: white;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #eee;
      overflow: hidden;
    }
    
    .saved-item-header {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .saved-item-info {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .saved-item-title {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .saved-item-details {
      font-size: 13px;
      color: #6b7280;
    }
    
    .saved-item-actions {
      display: flex;
      gap: 8px;
    }
    
    .saved-item-children {
      padding: 12px;
      background-color: #f9fafb;
    }
    
    .child-item {
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      background-color: white;
      border: 1px solid #eee;
    }
    
    .selection-actions {
      display: none;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #eef2ff;
      border-radius: 6px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-title {
      margin: 0;
      font-size: 18px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .combined-badge {
      font-size: 11px;
      background-color: #4f46e5;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 6px;
    }
    
    .expander {
      cursor: pointer;
      margin-right: 5px;
      display: inline-block;
      width: 16px;
      text-align: center;
    }
    
    .no-items, .no-projects {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }
    
    .projects-list-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .project-list-meta {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Quantity Surveyor Calculator</h1>
    <div class="project-controls">
      <span id="project-name">Untitled Project</span>
      <button id="export-pdf" class="btn btn-default">Export PDF</button>
      <button id="save-as-project" class="btn btn-primary">Save As</button>
      <button id="load-project" class="btn btn-default">Load Project</button>
    </div>
  </div>
  
  <div class="input-section">
    <div class="input-group">
      <label for="description">Description</label>
      <textarea id="description" rows="2" placeholder="Enter description"></textarea>
    </div>
    
    <div class="input-tabs">
      <div id="detailed-mode" class="input-tab active">Detailed Input</div>
      <div id="total-mode" class="input-tab">Total Input</div>
    </div>
    
    <div id="detailed-inputs">
      <div class="input-group">
        <label for="materials">Materials Cost (£)</label>
        <input type="text" id="materials" value="0">
      </div>
      <div class="input-group">
        <label for="labor">Labor Cost (£)</label>
        <input type="text" id="labor" value="0">
      </div>
    </div>
    
    <div id="total-inputs" style="display: none;">
      <div class="input-group">
        <label for="total-cost">Total Base Cost (£)</label>
        <input type="text" id="total-cost" value="0">
      </div>
    </div>
    
    <div class="input-group">
      <label for="overhead">Overhead (%)</label>
      <input type="text" id="overhead" value="15">
    </div>
    
    <div class="input-group">
      <label for="profit">Profit (%)</label>
      <input type="text" id="profit" value="10">
    </div>
    
    <div class="input-group">
      <label for="unit-type">Unit Type</label>
      <select id="unit-type">
        <option value="m2">Square Meter (m²)</option>
        <option value="m">Linear Meter (m)</option>
        <option value="item">Item</option>
        <option value="nr">Number (Nr)</option>
      </select>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="save-calculation" class="btn btn-primary">Save Calculation</button>
      <button id="clear-form" class="btn btn-default">Clear Form</button>
    </div>
  </div>
  
  <div class="results-section">
    <h2>Results</h2>
    
    <div id="detailed-results">
      <table class="results-table">
        <tr>
          <td>Materials</td>
          <td id="materials-result">£0.00</td>
        </tr>
        <tr>
          <td>Labor</td>
          <td id="labor-result">£0.00</td>
        </tr>
        <tr>
          <td>Subtotal</td>
          <td id="subtotal-result">£0.00</td>
        </tr>
        <tr>
          <td>Overhead (<span id="overhead-percent">15</span>%)</td>
          <td id="overhead-result">£0.00</td>
        </tr>
        <tr>
          <td>Profit (<span id="profit-percent">10</span>%)</td>
          <td id="profit-result">£0.00</td>
        </tr>
        <tr>
          <td><strong>Total</strong></td>
          <td id="final-total-result"><strong>£0.00</strong></td>
        </tr>
        <tr>
          <td>Rate per <span id="unit-display">m²</span></td>
          <td id="rate-result">£0.00</td>
        </tr>
      </table>
    </div>
    
    <div id="total-results" style="display: none;">
      <table class="results-table">
        <tr>
          <td>Base Cost</td>
          <td id="total-cost-result">£0.00</td>
        </tr>
        <tr>
          <td>Rate per <span id="unit-display-2">m²</span></td>
          <td id="rate-result-2">£0.00</td>
        </tr>
      </table>
    </div>
  </div>
  
  <div class="saved-items-section">
    <h2>Saved Calculations</h2>
    
    <div id="selection-actions" class="selection-actions">
      <span><span id="selected-count">0</span> items selected</span>
      <button id="combine-selected" class="btn btn-primary">Combine Selected</button>
      <button id="clear-selection" class="btn btn-default">Clear Selection</button>
    </div>
    
    <div id="saved-items-list">
      <div class="no-items">No saved calculations yet</div>
    </div>
  </div>
  
  <!-- Save Project Modal -->
  <div id="save-project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Save Project As</h3>
      </div>
      <div class="input-group">
        <label for="new-project-name">Project Name</label>
        <input type="text" id="new-project-name" placeholder="Enter project name">
      </div>
      <div class="modal-footer">
        <button id="cancel-save-project" class="btn btn-default">Cancel</button>
        <button id="confirm-save-project" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Load Project Modal -->
  <div id="load-project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Load Project</h3>
      </div>
      <div id="projects-list">
        <!-- Projects will be populated here -->
      </div>
      <div class="modal-footer">
        <button id="close-load-project" class="btn btn-default">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Combine Items Modal -->
  <div id="combine-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Combine Calculations</h3>
      </div>
      <div class="input-group">
        <label for="combine-description">Description</label>
        <input type="text" id="combine-description" placeholder="Enter description for combined item">
      </div>
      <div class="input-group">
        <label for="combine-unit">Unit Type</label>
        <select id="combine-unit">
          <option value="m2">Square Meter (m²)</option>
          <option value="m">Linear Meter (m)</option>
          <option value="item">Item</option>
          <option value="nr">Number (Nr)</option>
        </select>
      </div>
      <p>Combining <span id="combining-count">0</span> items:</p>
      <div id="combining-items-list">
        <!-- Selected items will be shown here -->
      </div>
      <div class="modal-footer">
        <button id="cancel-combine" class="btn btn-default">Cancel</button>
        <button id="confirm-combine" class="btn btn-primary">Combine</button>
      </div>
    </div>
  </div>
  
  <!-- Add to Combined Modal -->
  <div id="add-to-combined-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add to Combined Item</h3>
      </div>
      <p>Adding items to: <span id="target-combined-name"></span></p>
      <div id="selectable-items-list">
        <!-- Selectable items will be shown here -->
      </div>
      <div class="modal-footer">
        <button id="cancel-add-combined" class="btn btn-default">Cancel</button>
        <button id="confirm-add-combined" class="btn btn-primary">Add Selected</button>
      </div>
    </div>
  </div>

  <script>
    // State management
    let state = {
      currentProjectName: 'Untitled Project',
      savedProjects: [],
      description: '',
      inputMode: 'detailed',
      materials: 0,
      labor: 0,
      totalCost: 0,
      overhead: 15,
      profit: 10,
      unit: 'm2',
      savedItems: [],
      selectedItems: [],
      expandedItems: [],
      selectedCombinedItem: null,
      results: {
        subtotal: 0,
        overheadAmount: 0,
        profitAmount: 0,
        total: 0,
        ratePerUnit: 0
      }
    };

    // DOM Elements
    const elements = {};

    // Initialize when the document is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Get all DOM elements we need to interact with
      initializeElements();
      // Set up event listeners
      setupEventListeners();
      // Load saved data from localStorage
      loadStateFromStorage();
      // Update the UI
      updateUI();
    });

    // Get references to all DOM elements we need
    function initializeElements() {
      // Project controls
      elements.projectName = document.getElementById('project-name');
      elements.exportPdf = document.getElementById('export-pdf');
      elements.saveAsProject = document.getElementById('save-as-project');
      elements.loadProject = document.getElementById('load-project');
      // Input fields
      elements.description = document.getElementById('description');
      elements.detailedMode = document.getElementById('detailed-mode');
      elements.totalMode = document.getElementById('total-mode');
      elements.detailedInputs = document.getElementById('detailed-inputs');
      elements.totalInputs = document.getElementById('total-inputs');
      elements.materials = document.getElementById('materials');
      elements.labor = document.getElementById('labor');
      elements.totalCost = document.getElementById('total-cost');
      elements.overhead = document.getElementById('overhead');
      elements.profit = document.getElementById('profit');
      elements.unitType = document.getElementById('unit-type');
      elements.saveCalculation = document.getElementById('save-calculation');
      elements.clearForm = document.getElementById('clear-form');
      // Results elements
      elements.detailedResults = document.getElementById('detailed-results');
      elements.totalResults = document.getElementById('total-results');
      elements.materialsResult = document.getElementById('materials-result');
      elements.laborResult = document.getElementById('labor-result');
      elements.subtotalResult = document.getElementById('subtotal-result');
      elements.overheadPercent = document.getElementById('overhead-percent');
      elements.overheadResult = document.getElementById('overhead-result');
      elements.profitPercent = document.getElementById('profit-percent');
      elements.profitResult = document.getElementById('profit-result');
      elements.totalCost
